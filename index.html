async function procesarYDescargar() {
        const nombre = document.getElementById('nombre-input').value.trim().toLowerCase();
        const fecha = document.getElementById('fecha-input').value;

        if (!nombre || !fecha) return alert("Por favor completa nombre y fecha.");

        try {
            // --- CANDADO 1: ¿EL MAIL YA USÓ SU OPORTUNIDAD? ---
            // (Doble verificación por seguridad si el usuario intenta saltar el bloqueo visual)
            let { data: usuarioUsado } = await _supabase
                .from('perfiles')
                .select('uso_completado')
                .eq('email', emailActual)
                .maybeSingle();

            if (usuarioUsado && usuarioUsado.uso_completado) {
                alert("Tu correo ya ha sido utilizado para una consulta. No puedes realizar más estudios.");
                return location.reload();
            }

            // --- CANDADO 2: ¿ESTA PERSONA (NOMBRE+FECHA) YA FUE CONSULTADA? ---
            let { data: existeCopia } = await _supabase
                .from('perfiles')
                .select('*')
                .eq('nombre_completo', nombre)
                .eq('fecha_nacimiento', fecha)
                .maybeSingle();

            if (existeCopia) {
                alert("Este estudio (mismo nombre y fecha) ya existe en nuestra base de datos. No se permiten duplicados.");
                return;
            }

            // --- SI PASA AMBOS CANDADOS, GUARDAMOS Y GENERAMOS ---
            const { error } = await _supabase.from('perfiles').insert([
                { 
                    email: emailActual, 
                    nombre_completo: nombre, 
                    fecha_nacimiento: fecha, 
                    uso_completado: true 
                }
            ]);

            if (error) throw error;

            // GENERAR PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20);
            doc.text("Informe Numerológico", 20, 30);
            doc.setFontSize(14);
            doc.text(`Consultante: ${nombre.toUpperCase()}`, 20, 50);
            doc.text(`Fecha: ${fecha}`, 20, 60);
            doc.text("---------------------------------------", 20, 70);
            doc.text("Análisis completado.", 20, 80);
            
            doc.save(`Estudio_${nombre.replace(/ /g, "_")}.pdf`);
            
            alert("¡Éxito! Tu oportunidad ha sido utilizada. El sistema se bloqueará para este mail.");
            location.reload(); 

        } catch (e) {
            console.error(e);
            alert("Error al procesar los datos. Revisa la conexión.");
        }
    }
